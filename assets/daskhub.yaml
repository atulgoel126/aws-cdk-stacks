jupyterhub:
  hub:
    config:
      Authenticator:
        admin_users:
          - admin1
        allowed_users:
          - user1
      DummyAuthenticator:
        password: <PASSWORD>
      JupyterHub:
        authenticator_class: dummy
    services:
      dask-gateway:
        apiToken: "<API_TOKEN>"
    nodeSelector:
      karpenter.sh/nodepool: daskhub-on-demand
    tolerations:
      - key: "daskhub-on-demand"
        operator: "Exists"
        effect: "NoSchedule"
  proxy:
    secretToken: "<SECRET_TOKEN>"
    service:
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
        service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
        service.beta.kubernetes.io/aws-load-balancer-type: external
        service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
        service.beta.kubernetes.io/aws-load-balancer-ip-address-type: ipv4
    chp:
      nodeSelector:
        karpenter.sh/nodepool: daskhub-on-demand
      tolerations:
        - key: "daskhub-on-demand"
          operator: "Exists"
          effect: "NoSchedule"
  singleuser:
    nodeSelector:
      karpenter.sh/nodepool: daskhub-on-demand
    image:
      name: <NOTEBOOK_IMAGE>
      tag: <NOTEBOOK_IMAGE_TAG>
    cpu:
      limit: 2
      guarantee: 1
    memory:
      limit: 4G
      guarantee: 2G
    extraEnv:
      DASK_GATEWAY__CLUSTER__OPTIONS__IMAGE: "{JUPYTER_IMAGE_SPEC}"
  # prePuller:
  #   hook:
  #     nodeSelector:
  #       karpenter.sh/nodepool: daskhub-on-demand
  #     tolerations:
  #       - key: "daskhub-on-demand"
  #         operator: "Exists"
  #         effect: "NoSchedule"
  scheduling:
    userScheduler:
      nodeSelector:
        karpenter.sh/nodepool: daskhub-on-demand
      tolerations:
        - key: "daskhub-on-demand"
          operator: "Exists"
          effect: "NoSchedule"

dask-gateway:
  gateway:
    nodeSelector:
      karpenter.sh/nodepool: daskhub-on-demand
    tolerations:
      - key: "daskhub-on-demand"
        operator: "Exists"
        effect: "NoSchedule"
    backend:
      scheduler:
        extraPodConfig:
          nodeSelector:
            karpenter.sh/nodepool: daskhub-on-demand
          tolerations:
            - key: "daskhub-on-demand"
              operator: "Exists"
              effect: "NoSchedule"
      worker:
        extraPodConfig:
          nodeSelector:
            karpenter.sh/nodepool: daskhub-spot
          tolerations:
            - key: "daskhub-spot"
              operator: "Exists"
              effect: "NoSchedule"
    extraConfig:
      optionHandler: |
        from dask_gateway_server.options import Options, Integer, Float, String
        def option_handler(options):
            if ":" not in options.image:
                raise ValueError("When specifying an image you must also provide a tag")
            return {
                "worker_cores": options.worker_cores,
                "worker_memory": int(options.worker_memory * 2 ** 30),
                "image": options.image,
            }
        c.Backend.cluster_options = Options(
            Float("worker_cores", default=0.8, min=0.8, max=4.0, label="Worker Cores"),
            Float("worker_memory", default=3.3, min=1, max=8, label="Worker Memory (GiB)"),
            String("image", default="pangeo/base-notebook:<NOTEBOOK_IMAGE_TAG>", label="Image"),
            handler=option_handler,
        )
    auth:
      jupyterhub:
        apiToken: "<API_TOKEN>"
  controller:
    nodeSelector:
      karpenter.sh/nodepool: daskhub-on-demand
    tolerations:
      - key: "daskhub-on-demand"
        operator: "Exists"
        effect: "NoSchedule"
  traefik:
    nodeSelector:
      karpenter.sh/nodepool: daskhub-on-demand
    tolerations:
      - key: "daskhub-on-demand"
        operator: "Exists"
        effect: "NoSchedule"
